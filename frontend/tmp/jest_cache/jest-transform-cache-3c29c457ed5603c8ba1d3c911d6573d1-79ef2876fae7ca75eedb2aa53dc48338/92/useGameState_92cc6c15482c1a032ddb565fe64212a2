ab39e680f97f9f0a74229db482b039a0
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useGameState = void 0;
// src/hooks/useGameState.ts
const react_1 = require("react");
const GameTypes_1 = require("../types/GameTypes");
const formulaUtils_1 = require("../utils/formulaUtils");
const gridUtils_1 = require("../utils/gridUtils");
const useGameState = (initialGrid, targetGrid) => {
    const [gameState, setGameState] = (0, react_1.useState)({
        grid: initialGrid.map(row => [...row]), // Deep copy
        history: [initialGrid.map(row => [...row])], // Save initial state in history
        moves: 0
    });
    const setGrid = (0, react_1.useCallback)((newGrid) => {
        setGameState(prevState => ({
            ...prevState,
            grid: newGrid,
            history: [...prevState.history, newGrid],
            moves: prevState.moves + 1
        }));
    }, []);
    const applyMatterTransformation = (0, react_1.useCallback)((position, formula) => {
        const { row, col } = position;
        const { grid } = gameState;
        // If the cell is empty (VOID), do nothing
        if (grid[row][col] === GameTypes_1.MatterType.VOID)
            return;
        const newGrid = grid.map(row => [...row]); // Deep copy current grid
        // Get adjacent cells for formula evaluation
        const adjacentCells = (0, gridUtils_1.getAdjacentCells)(grid, row, col);
        if (formula) {
            // Apply specific formula if selected
            const shouldTransform = (0, formulaUtils_1.evaluateFormula)(formula.condition, grid[row][col], adjacentCells);
            if (shouldTransform) {
                // For simplicity, assuming result is always a MatterType
                newGrid[row][col] = formula.result;
                setGrid(newGrid);
            }
        }
        else {
            // Auto-apply first applicable formula based on game rules
            // Here we could implement game-specific rules from the project
            const waterToEarth = grid[row][col] === GameTypes_1.MatterType.WATER &&
                adjacentCells.filter(cell => cell === GameTypes_1.MatterType.FIRE).length >= 2;
            const earthToAir = grid[row][col] === GameTypes_1.MatterType.EARTH &&
                adjacentCells.includes(GameTypes_1.MatterType.WATER) &&
                adjacentCells.includes(GameTypes_1.MatterType.AETHER);
            const fireToWater = grid[row][col] === GameTypes_1.MatterType.FIRE &&
                adjacentCells.every(cell => cell === GameTypes_1.MatterType.VOID);
            const airToAether = grid[row][col] === GameTypes_1.MatterType.AIR &&
                adjacentCells.filter(cell => cell !== GameTypes_1.MatterType.VOID).length >= 3;
            const aetherToFire = grid[row][col] === GameTypes_1.MatterType.AETHER &&
                adjacentCells.includes(GameTypes_1.MatterType.AIR);
            if (waterToEarth) {
                newGrid[row][col] = GameTypes_1.MatterType.EARTH;
                setGrid(newGrid);
            }
            else if (earthToAir) {
                newGrid[row][col] = GameTypes_1.MatterType.AIR;
                setGrid(newGrid);
            }
            else if (fireToWater) {
                newGrid[row][col] = GameTypes_1.MatterType.WATER;
                setGrid(newGrid);
            }
            else if (airToAether) {
                newGrid[row][col] = GameTypes_1.MatterType.AETHER;
                setGrid(newGrid);
            }
            else if (aetherToFire) {
                newGrid[row][col] = GameTypes_1.MatterType.FIRE;
                setGrid(newGrid);
            }
        }
    }, [gameState, setGrid]);
    const undoLastMove = (0, react_1.useCallback)(() => {
        setGameState(prevState => {
            if (prevState.history.length <= 1)
                return prevState;
            const newHistory = [...prevState.history];
            newHistory.pop(); // Remove current state
            return {
                grid: newHistory[newHistory.length - 1].map(row => [...row]), // Deep copy last state
                history: newHistory,
                moves: prevState.moves - 1
            };
        });
    }, []);
    const resetGrid = (0, react_1.useCallback)(() => {
        setGameState({
            grid: initialGrid.map(row => [...row]), // Deep copy initial grid
            history: [initialGrid.map(row => [...row])], // Reset history with only initial state
            moves: 0
        });
    }, [initialGrid]);
    // Check if puzzle is solved by comparing with target grid
    const isSolved = (0, react_1.useCallback)(() => {
        if (!targetGrid)
            return false;
        const { grid } = gameState;
        // Compare current grid with target grid
        for (let i = 0; i < grid.length; i++) {
            for (let j = 0; j < grid[i].length; j++) {
                if (grid[i][j] !== targetGrid[i][j]) {
                    return false;
                }
            }
        }
        return true;
    }, [gameState, targetGrid]);
    return {
        grid: gameState.grid,
        moves: gameState.moves,
        setGrid,
        applyMatterTransformation,
        undoLastMove,
        resetGrid,
        isSolved: isSolved()
    };
};
exports.useGameState = useGameState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3NheWFudGFucGFsMTAwL0Rlc2t0b3AvTXVtdS0tb25jaGFpbi1wdXp6bGUtZ2FtZS9mcm9udGVuZC9zcmMvaG9va3MvdXNlR2FtZVN0YXRlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDRCQUE0QjtBQUM1QixpQ0FBOEM7QUFDOUMsa0RBQWtGO0FBQ2xGLHdEQUF3RDtBQUN4RCxrREFBc0Q7QUFFL0MsTUFBTSxZQUFZLEdBQUcsQ0FBQyxXQUEyQixFQUFFLFVBQTJCLEVBQUUsRUFBRTtJQUN2RixNQUFNLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxHQUFHLElBQUEsZ0JBQVEsRUFBWTtRQUNwRCxJQUFJLEVBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUFFLFlBQVk7UUFDcEQsT0FBTyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsZ0NBQWdDO1FBQzdFLEtBQUssRUFBRSxDQUFDO0tBQ1QsQ0FBQyxDQUFDO0lBRUgsTUFBTSxPQUFPLEdBQUcsSUFBQSxtQkFBVyxFQUFDLENBQUMsT0FBdUIsRUFBRSxFQUFFO1FBQ3RELFlBQVksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDekIsR0FBRyxTQUFTO1lBQ1osSUFBSSxFQUFFLE9BQU87WUFDYixPQUFPLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDO1lBQ3hDLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUM7U0FDM0IsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFUCxNQUFNLHlCQUF5QixHQUFHLElBQUEsbUJBQVcsRUFBQyxDQUFDLFFBQXNCLEVBQUUsT0FBdUIsRUFBRSxFQUFFO1FBQ2hHLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FB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T0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUU1QixPQUFPO1FBQ0wsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJO1FBQ3BCLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSztRQUN0QixPQUFPO1FBQ1AseUJBQXlCO1FBQ3pCLFlBQVk7UUFDWixTQUFTO1FBQ1QsUUFBUSxFQUFFLFFBQVEsRUFBRTtLQUNyQixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBaklXLFFBQUEsWUFBWSxnQkFpSXZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9zYXlhbnRhbnBhbDEwMC9EZXNrdG9wL011bXUtLW9uY2hhaW4tcHV6emxlLWdhbWUvZnJvbnRlbmQvc3JjL2hvb2tzL3VzZUdhbWVTdGF0ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvaG9va3MvdXNlR2FtZVN0YXRlLnRzXG5pbXBvcnQgeyB1c2VTdGF0ZSwgdXNlQ2FsbGJhY2sgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBNYXR0ZXJUeXBlLCBHcmlkUG9zaXRpb24sIEZvcm11bGEsIEdhbWVTdGF0ZSB9IGZyb20gJy4uL3R5cGVzL0dhbWVUeXBlcyc7XG5pbXBvcnQgeyBldmFsdWF0ZUZvcm11bGEgfSBmcm9tICcuLi91dGlscy9mb3JtdWxhVXRpbHMnO1xuaW1wb3J0IHsgZ2V0QWRqYWNlbnRDZWxscyB9IGZyb20gJy4uL3V0aWxzL2dyaWRVdGlscyc7XG5cbmV4cG9ydCBjb25zdCB1c2VHYW1lU3RhdGUgPSAoaW5pdGlhbEdyaWQ6IE1hdHRlclR5cGVbXVtdLCB0YXJnZXRHcmlkPzogTWF0dGVyVHlwZVtdW10pID0+IHtcbiAgY29uc3QgW2dhbWVTdGF0ZSwgc2V0R2FtZVN0YXRlXSA9IHVzZVN0YXRlPEdhbWVTdGF0ZT4oe1xuICAgIGdyaWQ6IGluaXRpYWxHcmlkLm1hcChyb3cgPT4gWy4uLnJvd10pLCAvLyBEZWVwIGNvcHlcbiAgICBoaXN0b3J5OiBbaW5pdGlhbEdyaWQubWFwKHJvdyA9PiBbLi4ucm93XSldLCAvLyBTYXZlIGluaXRpYWwgc3RhdGUgaW4gaGlzdG9yeVxuICAgIG1vdmVzOiAwXG4gIH0pO1xuICBcbiAgY29uc3Qgc2V0R3JpZCA9IHVzZUNhbGxiYWNrKChuZXdHcmlkOiBNYXR0ZXJUeXBlW11bXSkgPT4ge1xuICAgIHNldEdhbWVTdGF0ZShwcmV2U3RhdGUgPT4gKHtcbiAgICAgIC4uLnByZXZTdGF0ZSxcbiAgICAgIGdyaWQ6IG5ld0dyaWQsXG4gICAgICBoaXN0b3J5OiBbLi4ucHJldlN0YXRlLmhpc3RvcnksIG5ld0dyaWRdLFxuICAgICAgbW92ZXM6IHByZXZTdGF0ZS5tb3ZlcyArIDFcbiAgICB9KSk7XG4gIH0sIFtdKTtcbiAgXG4gIGNvbnN0IGFwcGx5TWF0dGVyVHJhbnNmb3JtYXRpb24gPSB1c2VDYWxsYmFjaygocG9zaXRpb246IEdyaWRQb3NpdGlvbiwgZm9ybXVsYTogRm9ybXVsYSB8IG51bGwpID0+IHtcbiAgICBjb25zdCB7IHJvdywgY29sIH0gPSBwb3NpdGlvbjtcbiAgICBjb25zdCB7IGdyaWQgfSA9IGdhbWVTdGF0ZTtcbiAgICBcbiAgICAvLyBJZiB0aGUgY2VsbCBpcyBlbXB0eSAoVk9JRCksIGRvIG5vdGhpbmdcbiAgICBpZiAoZ3JpZFtyb3ddW2NvbF0gPT09IE1hdHRlclR5cGUuVk9JRCkgcmV0dXJuO1xuICAgIFxuICAgIGNvbnN0IG5ld0dyaWQgPSBncmlkLm1hcChyb3cgPT4gWy4uLnJvd10pOyAvLyBEZWVwIGNvcHkgY3VycmVudCBncmlkXG4gICAgXG4gICAgLy8gR2V0IGFkamFjZW50IGNlbGxzIGZvciBmb3JtdWxhIGV2YWx1YXRpb25cbiAgICBjb25zdCBhZGphY2VudENlbGxzID0gZ2V0QWRqYWNlbnRDZWxscyhncmlkLCByb3csIGNvbCk7XG4gICAgXG4gICAgaWYgKGZvcm11bGEpIHtcbiAgICAgIC8vIEFwcGx5IHNwZWNpZmljIGZvcm11bGEgaWYgc2VsZWN0ZWRcbiAgICAgIGNvbnN0IHNob3VsZFRyYW5zZm9ybSA9IGV2YWx1YXRlRm9ybXVsYShcbiAgICAgICAgZm9ybXVsYS5jb25kaXRpb24sIFxuICAgICAgICBncmlkW3Jvd11bY29sXSwgXG4gICAgICAgIGFkamFjZW50Q2VsbHNcbiAgICAgICk7XG4gICAgICBcbiAgICAgIGlmIChzaG91bGRUcmFuc2Zvcm0pIHtcbiAgICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIGFzc3VtaW5nIHJlc3VsdCBpcyBhbHdheXMgYSBNYXR0ZXJUeXBlXG4gICAgICAgIG5ld0dyaWRbcm93XVtjb2xdID0gZm9ybXVsYS5yZXN1bHQgYXMgTWF0dGVyVHlwZTtcbiAgICAgICAgc2V0R3JpZChuZXdHcmlkKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQXV0by1hcHBseSBmaXJzdCBhcHBsaWNhYmxlIGZvcm11bGEgYmFzZWQgb24gZ2FtZSBydWxlc1xuICAgICAgLy8gSGVyZSB3ZSBjb3VsZCBpbXBsZW1lbnQgZ2FtZS1zcGVjaWZpYyBydWxlcyBmcm9tIHRoZSBwcm9qZWN0XG4gICAgICBjb25zdCB3YXRlclRvRWFydGggPSBncmlkW3Jvd11bY29sXSA9PT0gTWF0dGVyVHlwZS5XQVRFUiAmJiBcbiAgICAgICAgYWRqYWNlbnRDZWxscy5maWx0ZXIoY2VsbCA9PiBjZWxsID09PSBNYXR0ZXJUeXBlLkZJUkUpLmxlbmd0aCA+PSAyO1xuICAgICAgXG4gICAgICBjb25zdCBlYXJ0aFRvQWlyID0gZ3JpZFtyb3ddW2NvbF0gPT09IE1hdHRlclR5cGUuRUFSVEggJiYgXG4gICAgICAgIGFkamFjZW50Q2VsbHMuaW5jbHVkZXMoTWF0dGVyVHlwZS5XQVRFUikgJiZcbiAgICAgICAgYWRqYWNlbnRDZWxscy5pbmNsdWRlcyhNYXR0ZXJUeXBlLkFFVEhFUik7XG4gICAgICBcbiAgICAgIGNvbnN0IGZpcmVUb1dhdGVyID0gZ3JpZFtyb3ddW2NvbF0gPT09IE1hdHRlclR5cGUuRklSRSAmJlxuICAgICAgICBhZGphY2VudENlbGxzLmV2ZXJ5KGNlbGwgPT4gY2VsbCA9PT0gTWF0dGVyVHlwZS5WT0lEKTtcbiAgICAgIFxuICAgICAgY29uc3QgYWlyVG9BZXRoZXIgPSBncmlkW3Jvd11bY29sXSA9PT0gTWF0dGVyVHlwZS5BSVIgJiZcbiAgICAgICAgYWRqYWNlbnRDZWxscy5maWx0ZXIoY2VsbCA9PiBjZWxsICE9PSBNYXR0ZXJUeXBlLlZPSUQpLmxlbmd0aCA+PSAzO1xuICAgICAgXG4gICAgICBjb25zdCBhZXRoZXJUb0ZpcmUgPSBncmlkW3Jvd11bY29sXSA9PT0gTWF0dGVyVHlwZS5BRVRIRVIgJiZcbiAgICAgICAgYWRqYWNlbnRDZWxscy5pbmNsdWRlcyhNYXR0ZXJUeXBlLkFJUik7XG4gICAgICBcbiAgICAgIGlmICh3YXRlclRvRWFydGgpIHtcbiAgICAgICAgbmV3R3JpZFtyb3ddW2NvbF0gPSBNYXR0ZXJUeXBlLkVBUlRIO1xuICAgICAgICBzZXRHcmlkKG5ld0dyaWQpO1xuICAgICAgfSBlbHNlIGlmIChlYXJ0aFRvQWlyKSB7XG4gICAgICAgIG5ld0dyaWRbcm93XVtjb2xdID0gTWF0dGVyVHlwZS5BSVI7XG4gICAgICAgIHNldEdyaWQobmV3R3JpZCk7XG4gICAgICB9IGVsc2UgaWYgKGZpcmVUb1dhdGVyKSB7XG4gICAgICAgIG5ld0dyaWRbcm93XVtjb2xdID0gTWF0dGVyVHlwZS5XQVRFUjtcbiAgICAgICAgc2V0R3JpZChuZXdHcmlkKTtcbiAgICAgIH0gZWxzZSBpZiAoYWlyVG9BZXRoZXIpIHtcbiAgICAgICAgbmV3R3JpZFtyb3ddW2NvbF0gPSBNYXR0ZXJUeXBlLkFFVEhFUjtcbiAgICAgICAgc2V0R3JpZChuZXdHcmlkKTtcbiAgICAgIH0gZWxzZSBpZiAoYWV0aGVyVG9GaXJlKSB7XG4gICAgICAgIG5ld0dyaWRbcm93XVtjb2xdID0gTWF0dGVyVHlwZS5GSVJFO1xuICAgICAgICBzZXRHcmlkKG5ld0dyaWQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgW2dhbWVTdGF0ZSwgc2V0R3JpZF0pO1xuICBcbiAgY29uc3QgdW5kb0xhc3RNb3ZlID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIHNldEdhbWVTdGF0ZShwcmV2U3RhdGUgPT4ge1xuICAgICAgaWYgKHByZXZTdGF0ZS5oaXN0b3J5Lmxlbmd0aCA8PSAxKSByZXR1cm4gcHJldlN0YXRlO1xuICAgICAgXG4gICAgICBjb25zdCBuZXdIaXN0b3J5ID0gWy4uLnByZXZTdGF0ZS5oaXN0b3J5XTtcbiAgICAgIG5ld0hpc3RvcnkucG9wKCk7IC8vIFJlbW92ZSBjdXJyZW50IHN0YXRlXG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGdyaWQ6IG5ld0hpc3RvcnlbbmV3SGlzdG9yeS5sZW5ndGggLSAxXS5tYXAocm93ID0+IFsuLi5yb3ddKSwgLy8gRGVlcCBjb3B5IGxhc3Qgc3RhdGVcbiAgICAgICAgaGlzdG9yeTogbmV3SGlzdG9yeSxcbiAgICAgICAgbW92ZXM6IHByZXZTdGF0ZS5tb3ZlcyAtIDFcbiAgICAgIH07XG4gICAgfSk7XG4gIH0sIFtdKTtcbiAgXG4gIGNvbnN0IHJlc2V0R3JpZCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBzZXRHYW1lU3RhdGUoe1xuICAgICAgZ3JpZDogaW5pdGlhbEdyaWQubWFwKHJvdyA9PiBbLi4ucm93XSksIC8vIERlZXAgY29weSBpbml0aWFsIGdyaWRcbiAgICAgIGhpc3Rvcnk6IFtpbml0aWFsR3JpZC5tYXAocm93ID0+IFsuLi5yb3ddKV0sIC8vIFJlc2V0IGhpc3Rvcnkgd2l0aCBvbmx5IGluaXRpYWwgc3RhdGVcbiAgICAgIG1vdmVzOiAwXG4gICAgfSk7XG4gIH0sIFtpbml0aWFsR3JpZF0pO1xuICBcbiAgLy8gQ2hlY2sgaWYgcHV6emxlIGlzIHNvbHZlZCBieSBjb21wYXJpbmcgd2l0aCB0YXJnZXQgZ3JpZFxuICBjb25zdCBpc1NvbHZlZCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAoIXRhcmdldEdyaWQpIHJldHVybiBmYWxzZTtcbiAgICBcbiAgICBjb25zdCB7IGdyaWQgfSA9IGdhbWVTdGF0ZTtcbiAgICBcbiAgICAvLyBDb21wYXJlIGN1cnJlbnQgZ3JpZCB3aXRoIHRhcmdldCBncmlkXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmlkLmxlbmd0aDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGdyaWRbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgaWYgKGdyaWRbaV1bal0gIT09IHRhcmdldEdyaWRbaV1bal0pIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHRydWU7XG4gIH0sIFtnYW1lU3RhdGUsIHRhcmdldEdyaWRdKTtcbiAgXG4gIHJldHVybiB7XG4gICAgZ3JpZDogZ2FtZVN0YXRlLmdyaWQsXG4gICAgbW92ZXM6IGdhbWVTdGF0ZS5tb3ZlcyxcbiAgICBzZXRHcmlkLFxuICAgIGFwcGx5TWF0dGVyVHJhbnNmb3JtYXRpb24sXG4gICAgdW5kb0xhc3RNb3ZlLFxuICAgIHJlc2V0R3JpZCxcbiAgICBpc1NvbHZlZDogaXNTb2x2ZWQoKVxuICB9O1xufTtcbiJdLCJ2ZXJzaW9uIjozfQ==