{"version":3,"file":"utils.js","names":["isInteger","value","INTEGER_REGEX","test","isNumber","NUMBER_REGEX","isSafeNumber","config","num","Number","parseFloat","str","String","valueDigits","countSignificantDigits","strDigits","approx","requiredDigits","UnsafeNumberReason","getUnsafeNumberReason","undefined","truncate_integer","isFinite","overflow","underflow","truncate_float","toSafeNumberOrThrow","number","unsafeReason","unsafeReasonText","replace","Error","splitNumber","match","SyntaxError","sign","digitsStr","exponent","parseInt","dot","indexOf","length","digits","zeros","compareNumber","a","b","aa","bb","start","end","lastIndexOf"],"sources":["../../src/utils.ts"],"sourcesContent":["import type { NumberSplit } from './types'\n\n/**\n * Test whether a string contains an integer number\n */\nexport function isInteger(value: string): boolean {\n  return INTEGER_REGEX.test(value)\n}\n\nconst INTEGER_REGEX = /^-?[0-9]+$/\n\n/**\n * Test whether a string contains a number\n * http://stackoverflow.com/questions/13340717/json-numbers-regular-expression\n */\nexport function isNumber(value: string): boolean {\n  return NUMBER_REGEX.test(value)\n}\n\nconst NUMBER_REGEX = /^-?(?:0|[1-9]\\d*)(?:\\.\\d+)?(?:[eE][+-]?\\d+)?$/\n\n/**\n * Test whether a string can be safely represented with a number\n * without information loss.\n *\n * When approx is true, floating point numbers that lose a few digits but\n * are still approximately equal in value are considered safe too.\n * Integer numbers must still be exactly equal.\n */\nexport function isSafeNumber(\n  value: string,\n  config?: {\n    approx: boolean\n  }\n): boolean {\n  const num = Number.parseFloat(value)\n  const str = String(num)\n\n  if (value === str) {\n    return true\n  }\n\n  const valueDigits = countSignificantDigits(value)\n  const strDigits = countSignificantDigits(str)\n\n  if (valueDigits === strDigits) {\n    return true\n  }\n\n  if (config?.approx === true) {\n    // A value is approximately equal when:\n    // 1. it is a floating point number, not an integer\n    // 2. it has at least 14 digits\n    // 3. the first 14 digits are equal\n    const requiredDigits = 14\n    if (strDigits >= requiredDigits && !isInteger(value)) {\n      return true\n    }\n  }\n\n  return false\n}\n\nexport enum UnsafeNumberReason {\n  underflow = 'underflow',\n  overflow = 'overflow',\n  truncate_integer = 'truncate_integer',\n  truncate_float = 'truncate_float'\n}\n\n/**\n * When the provided value is an unsafe number, describe what the reason is:\n * overflow, underflow, truncate_integer, or truncate_float.\n * Returns undefined when the value is safe.\n */\nexport function getUnsafeNumberReason(value: string): UnsafeNumberReason | undefined {\n  if (isSafeNumber(value, { approx: false })) {\n    return undefined\n  }\n\n  if (isInteger(value)) {\n    return UnsafeNumberReason.truncate_integer\n  }\n\n  const num = Number.parseFloat(value)\n  if (!Number.isFinite(num)) {\n    return UnsafeNumberReason.overflow\n  }\n\n  if (num === 0) {\n    return UnsafeNumberReason.underflow\n  }\n\n  return UnsafeNumberReason.truncate_float\n}\n\n/**\n * Convert a string into a number when it is safe to do so.\n * Throws an error otherwise, explaining the reason.\n */\nexport function toSafeNumberOrThrow(\n  value: string,\n  config?: {\n    approx: boolean\n  }\n): number {\n  const number = Number.parseFloat(value)\n\n  const unsafeReason = getUnsafeNumberReason(value)\n  if (\n    config?.approx === true\n      ? unsafeReason && unsafeReason !== UnsafeNumberReason.truncate_float\n      : unsafeReason\n  ) {\n    const unsafeReasonText = unsafeReason?.replace(/_\\w+$/, '')\n    throw new Error(\n      `Cannot safely convert to number: the value '${value}' would ${unsafeReasonText} and become ${number}`\n    )\n  }\n\n  return number\n}\n\n/**\n * Split a number into sign, digits, and exponent.\n * The value can be constructed again from a split number by inserting a dot\n * at the second character of the digits if there is more than one digit,\n * prepending it with the sign, and appending the exponent like `e${exponent}`\n */\nexport function splitNumber(value: string): NumberSplit {\n  const match = value.match(/^(-?)(\\d+\\.?\\d*)([eE]([+-]?\\d+))?$/)\n  if (!match) {\n    throw new SyntaxError(`Invalid number: ${value}`)\n  }\n\n  const sign = match[1] as '-' | ''\n  const digitsStr = match[2]\n  let exponent = match[4] !== undefined ? Number.parseInt(match[4]) : 0\n\n  const dot = digitsStr.indexOf('.')\n  exponent += dot !== -1 ? dot - 1 : digitsStr.length - 1\n\n  const digits = digitsStr\n    .replace('.', '') // remove the dot (must be removed before removing leading zeros)\n    .replace(/^0*/, (zeros: string) => {\n      // remove leading zeros, add their count to the exponent\n      exponent -= zeros.length\n      return ''\n    })\n    .replace(/0*$/, '') // remove trailing zeros\n\n  return digits.length > 0\n    ? { sign, digits, exponent }\n    : { sign, digits: '0', exponent: exponent + 1 }\n}\n\n/**\n * Compare two strings containing a numeric value\n * Returns 1 when a is larger than b, 0 when they are equal,\n * and -1 when a is smaller than b.\n */\nexport function compareNumber(a: string, b: string): 1 | 0 | -1 {\n  if (a === b) {\n    return 0\n  }\n\n  const aa = splitNumber(a)\n  const bb = splitNumber(b)\n\n  type Sign = -1 | 1\n\n  const sign: Sign = aa.sign === '-' ? -1 : 1\n\n  if (aa.sign !== bb.sign) {\n    if (aa.digits === '0' && bb.digits === '0') {\n      return 0\n    }\n\n    return sign\n  }\n\n  if (aa.exponent !== bb.exponent) {\n    return aa.exponent > bb.exponent ? sign : aa.exponent < bb.exponent ? (-sign as Sign) : 0\n  }\n\n  return aa.digits > bb.digits ? sign : aa.digits < bb.digits ? (-sign as Sign) : 0\n}\n\n/**\n * Count the significant digits of a number.\n *\n * For example:\n *   '2.34' returns 3\n *   '-77' returns 2\n *   '0.003400' returns 2\n *   '120.5e+30' returns 4\n **/\nexport function countSignificantDigits(value: string): number {\n  let start = 0\n  if (value[0] === '-') {\n    start++\n  }\n  while (value[start] === '0' || value[start] === '.') {\n    start++\n  }\n\n  let end = value.lastIndexOf('e')\n  if (end === -1) {\n    end = value.lastIndexOf('E')\n  }\n  if (end === -1) {\n    end = value.length\n  }\n  while (value[end - 1] === '0' || value[end - 1] === '.') {\n    end--\n  }\n\n  let digits = end >= start ? end - start : 0\n\n  const dot = value.indexOf('.', start)\n  if (dot !== -1 && dot < end) {\n    digits--\n  }\n\n  return digits\n}\n"],"mappings":"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","ignoreList":[]}